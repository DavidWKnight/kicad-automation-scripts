stages:
  - docker-base-image
  - test
  - export
  - docker-image

variables:
  DOCKER_TAG: latest

build-docker-base-image:
  stage: docker-base-image
  tags:
    - runnersv2-shell
  only:
    changes:
      - Dockerfile-base
      - config/*
  before_script:
    - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
  script:
    - docker build -f Dockerfile-base -t productize/kicad-automation-base:$DOCKER_TAG .
    - docker push productize/kicad-automation-base

test-erc:
  image: productize/kicad-automation-base
  tags:
    - docker
  script:
    - ./eeschema/schematic.py run_erc ./test-projects/good-project/good-project.sch output
  stage: test
  artifacts:
    paths:
      - output
    expire_in: 1 day

export-schematic-pdf:
  image: productize/kicad-automation-base
  tags:
    - docker
  script:
    - ./eeschema/schematic.py export -a -f pdf ./test-projects/good-project/good-project.sch output
  stage: export
  artifacts:
    paths:
      - output
    expire_in: 1 day

test-drc:
  image: productize/kicad-automation-base
  tags:
    - docker
  script:
    - ./pcbnew_scripts/run_drc.py ./test-projects/good-project/good-project.kicad_pcb output
  stage: test

export-layout-svg:
  image: productize/kicad-automation-base
  tags:
    - docker
  script:
    - ./pcbnew_scripts/generate_svg.py ./test-projects/good-project/good-project.kicad_pcb
  stage: export
  artifacts:
    paths:
      - build
    expire_in: 1 day

build-docker-image:
  stage: docker-image
  tags:
    - runnersv2-shell
  before_script:
    - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USER --password-stdin
  script:
    - docker build -t productize/kicad-automation-scripts --build-arg base_tag=$DOCKER_TAG .
    - docker push productize/kicad-automation-scripts
